<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>è´·æ¬¾æå–è¿˜æ¬¾è®¡ç®—å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #e8edff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --bg: #f8fafc;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px 12px 24px;
      font-family: "Segoe UI", Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 15% 20%, #eef2ff, transparent 35%),
        radial-gradient(circle at 85% 10%, #e0f2fe, transparent 30%),
        radial-gradient(circle at 80% 80%, #ecfeff, transparent 35%),
        var(--bg);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 18px 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
    }

    h2 {
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    .lead {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 12px;
    }

    .row {
      margin-bottom: 12px;
    }

    .flex {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    label {
      color: var(--text);
      font-size: 12px;
    }

    input,
    select,
    button {
      padding: 6px 8px;
      margin: 2px 0;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 12px;
    }

    input:focus,
    select:focus {
      outline: 2px solid var(--primary-soft);
      border-color: var(--primary);
    }

    .radio-group {
      display: inline-flex;
      gap: 10px;
    }

    .chip {
      background: var(--primary-soft);
      padding: 3px 6px;
      border-radius: 4px;
      margin: 0;
      border: 1px solid #dfe6ff;
      color: #1e3a8a;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }

    .chips {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 120px;
      overflow-y: auto;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.25);
    }

    .btn-text {
      background: transparent;
      color: var(--primary);
      border: none;
      padding: 3px 5px;
      cursor: pointer;
      font-size: 11px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
      font-size: 11px;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 5px 7px;
      text-align: right;
    }

    th {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .note {
      font-size: 10px;
      color: var(--muted);
      text-align: left;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .summary-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      background: #f8fafc;
    }

    .summary-title {
      color: var(--muted);
      font-size: 10px;
      margin: 0 0 4px;
      letter-spacing: 0.3px;
    }

    .summary-value {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      line-height: 1.2;
    }

    .current-row {
      background:#C1FFC1
    }

    /* å›¾è¡¨æ ·å¼ */
    .chart-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    }

    .chart-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: var(--text);
      font-weight: 600;
    }

    .prediction-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    }

    .prediction-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .prediction-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .prediction-item, .metric-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .prediction-item:last-child, .metric-item:last-child {
      border-bottom: none;
    }

    .prediction-label, .metric-label {
      font-size: 10px;
      color: var(--muted);
    }

    .prediction-value, .metric-value {
      font-size: 11px;
      font-weight: 600;
      color: var(--primary);
    }

    .tip-item {
      font-size: 10px;
      color: var(--muted);
      padding: 3px 0;
      line-height: 1.3;
    }

    .tip-item:before {
      content: "â€¢ ";
      color: var(--primary);
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="app">
    <h2>è´·æ¬¾åˆ©ç‡å˜æ›´è®¡ç®—åˆ†æå™¨</h2>
    <p class="lead">ä¸“é—¨åˆ†æåˆ©ç‡å˜æ›´æ—¶çš„ä¸åŒè®¡ç®—æ–¹å¼ï¼Œå¸®ä½ æ‰¾å‡ºé“¶è¡Œå®é™…é‡‡ç”¨çš„è®¡ç®—é€»è¾‘ã€‚</p>


    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 16px; background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
      <label style="font-size: 13px; font-weight: 500;">è´·æ¬¾é‡‘é¢(å…ƒ)<br><input type="number" id="principal" value="720000" style="width: 100%; padding: 8px; font-size: 14px; font-weight: 600;" /></label>
      <label style="font-size: 13px; font-weight: 500;">å¹´åˆ©ç‡(%)<br><input type="number" id="annualRate" step="0.01" value="3.1" style="width: 100%; padding: 8px; font-size: 14px; font-weight: 600;" /></label>
      <label style="font-size: 13px; font-weight: 500;">æ€»æœŸæ•°(æœˆ)<br><input type="number" id="months" value="360" style="width: 100%; padding: 8px; font-size: 14px; font-weight: 600;" /></label>
      <label style="font-size: 13px; font-weight: 500;">é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸ<br><input type="date" id="firstPayDate" value="2022-12-26" style="width: 100%; padding: 8px; font-size: 14px; font-weight: 600;" /></label>
      <label style="font-size: 13px; font-weight: 500;">è¿˜æ¬¾æ–¹å¼<br>
        <select id="repayType" style="width:100%; padding: 8px; font-size: 14px; font-weight: 600; border-radius: 6px; border: 1px solid var(--border);">
          <!-- <option value="annuity" selected>ç­‰é¢æœ¬æ¯</option> -->
          <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
        </select>
      </label>
    </div>

    <div class="divider"></div>

    <!-- ä¸¤åˆ—å¸ƒå±€ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
      
      <!-- å·¦åˆ—ï¼šåˆ©ç‡å˜æ›´ -->
      <div style="border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: #fafbfc;">
        <div class="section-title" style="font-size: 11px; margin-bottom: 4px;">åˆ©ç‡å˜æ›´ï¼ˆå¯å¤šæ¡ï¼‰</div>
        <div class="flex" style="gap: 6px;">
          <label style="font-size: 11px;">åˆ©ç‡ <input type="number" id="rateChangeValue" step="0.01" value="2.85" style="width:60px; padding: 4px 6px; font-size: 11px;" /> %</label>
          <label style="font-size: 11px;">å˜æ›´ç”Ÿæ•ˆæ—¥ <input type="date" id="rateChangeDate" value="2023-12-08" style="width:120px; padding: 4px 6px; font-size: 11px;" /></label>
          <button class="btn-primary" onclick="addRateChange()" style="padding: 4px 8px; font-size: 11px;">æ·»åŠ </button>
        </div>
        <div id="rateChanges" class="chips" style="margin-top: 6px;"></div>
      </div>

      <!-- å³åˆ—ï¼šæå‰è¿˜æ¬¾ -->
      <div style="border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: #fafbfc;">
        <div class="section-title" style="font-size: 11px; margin-bottom: 4px;">æå‰è¿˜æ¬¾ï¼ˆå¯å¤šæ¡ï¼‰</div>
        <div class="flex" style="gap: 6px;">
          <label style="font-size: 11px;">é¢å¤–è¿˜ <input type="number" id="prepayAmount" value="50000" style="width:80px; padding: 4px 6px; font-size: 11px;" /> å…ƒ</label>
          <label style="font-size: 11px;">æå‰è¿˜æ¬¾æ—¥ <input type="date" id="prepayDate" style="width:120px; padding: 4px 6px; font-size: 11px;" /></label>
          <select id="prepayMode" style="width:140px;" hidden="true">
            <option value="reducePayment">ä¿æŒæœŸæ•°ï¼Œé™ä½æœˆä¾›</option>
          </select>
          <button class="btn-primary" onclick="addPrepay()" style="padding: 4px 8px; font-size: 11px;">æ·»åŠ </button>
        </div>
        <div id="prepays" class="chips" style="margin-top: 6px;"></div>
      </div>
      
    </div>

    <div class="divider"></div>

    <button class="btn-primary" style="width: 100%; padding: 8px; font-size: 13px;" onclick="calc()">è®¡ç®—</button>

    <!-- å›¾è¡¨åˆ†æåŒºåŸŸ -->
    <div id="chartsContainer" style="display: none; margin-top: 16px;">
      <div class="section-title" style="margin-bottom: 10px;">ğŸ“Š æ•°æ®åˆ†æä¸é¢„æµ‹</div>
      
      <!-- å›¾è¡¨ç½‘æ ¼å¸ƒå±€ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; margin-bottom: 12px;">
        
        <!-- è¿˜æ¬¾è¶‹åŠ¿å›¾ -->
        <div class="chart-card">
          <h4>ğŸ’° è¿˜æ¬¾è¶‹åŠ¿åˆ†æ</h4>
          <canvas id="paymentTrendChart" width="400" height="200"></canvas>
        </div>
        
        <!-- æå‰è¿˜æ¬¾æ•ˆæœ -->
        <div class="chart-card">
          <h4>âš¡ æå‰è¿˜æ¬¾æ•ˆæœ</h4>
          <canvas id="prepayEffectChart" width="400" height="200"></canvas>
        </div>
        
        <!-- å¹´åº¦æ±‡æ€»åˆ†æ -->
        <div class="chart-card">
          <h4>ğŸ“… å¹´åº¦æ”¯å‡ºåˆ†æ</h4>
          <canvas id="yearlyAnalysisChart" width="400" height="200"></canvas>
        </div>
        
      </div>
      
      <!-- é¢„æµ‹åˆ†æå¡ç‰‡ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-bottom: 12px;">
        
        <div class="prediction-card">
          <div class="prediction-title">ğŸ”® æ™ºèƒ½é¢„æµ‹</div>
          <div id="smartPrediction" class="prediction-content">
            <div class="prediction-item">
              <span class="prediction-label">é¢„è®¡å®Œæˆæ—¶é—´:</span>
              <span class="prediction-value" id="predictedEndDate">-</span>
            </div>
            <div class="prediction-item">
              <span class="prediction-label">å‰©ä½™æ€»åˆ©æ¯:</span>
              <span class="prediction-value" id="remainingInterest">-</span>
            </div>
            <div class="prediction-item">
              <span class="prediction-label">æœˆå‡è¿˜æ¬¾:</span>
              <span class="prediction-value" id="avgMonthlyPayment">-</span>
            </div>
          </div>
        </div>
        
        <div class="prediction-card">
          <div class="prediction-title">ğŸ’¡ ä¼˜åŒ–å»ºè®®</div>
          <div id="optimizationTips" class="prediction-content">
            <div class="tip-item" id="tip1">åˆ†æä¸­...</div>
            <div class="tip-item" id="tip2"></div>
            <div class="tip-item" id="tip3"></div>
          </div>
        </div>
        
        <div class="prediction-card">
          <div class="prediction-title">ğŸ“Š å…³é”®æŒ‡æ ‡</div>
          <div id="keyMetrics" class="prediction-content">
            <div class="metric-item">
              <span class="metric-label">åˆ©æ¯å æ¯”:</span>
              <span class="metric-value" id="interestRatio">-</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">å·²è¿˜è¿›åº¦:</span>
              <span class="metric-value" id="paymentProgress">-</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">èŠ‚çœåˆ©æ¯:</span>
              <span class="metric-value" id="savedInterest">-</span>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const STORAGE_KEY = 'loan_calc_state';
    const rateChanges = [];
    const prepays = [];

    function saveState() {
      const state = {
        principal: document.getElementById('principal').value,
        annualRate: document.getElementById('annualRate').value,
        months: document.getElementById('months').value,
        repayType: document.getElementById('repayType')?.value || 'annuity',
        prepayMode: document.getElementById('prepayMode')?.value || 'reducePayment',
        rateChanges,
        prepays,
        rateChangeForm: {
          rate: document.getElementById('rateChangeValue').value,
          date: document.getElementById('rateChangeDate').value
        },
        prepayForm: {
          amount: document.getElementById('prepayAmount').value,
          date: document.getElementById('prepayDate').value
        },
        firstPayDate: document.getElementById('firstPayDate').value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s.principal) document.getElementById('principal').value = s.principal;
        if (s.annualRate) document.getElementById('annualRate').value = s.annualRate;
        if (s.months) document.getElementById('months').value = s.months;
        if (s.repayType) {
          const select = document.getElementById('repayType');
          if (select) select.value = s.repayType;
        }
        if (s.prepayMode) {
          const select = document.getElementById('prepayMode');
          // å†å²æ•°æ®è‹¥ä¸ºâ€œä¿æŒæœˆä¾›ï¼Œç¼©çŸ­æœŸæ•°â€ï¼Œç»Ÿä¸€å›é€€ä¸ºâ€œä¿æŒæœŸæ•°ï¼Œé™ä½æœˆä¾›â€
          const normalizedMode = s.prepayMode === 'reduceTerm' ? 'reducePayment' : s.prepayMode;
          if (select) select.value = normalizedMode;
        }
        if (Array.isArray(s.rateChanges)) {
          rateChanges.splice(0, rateChanges.length, ...s.rateChanges);
        }
        if (Array.isArray(s.prepays)) {
          prepays.splice(0, prepays.length, ...s.prepays);
        }
        if (s.rateChangeForm) {
          if (s.rateChangeForm.rate) document.getElementById('rateChangeValue').value = s.rateChangeForm.rate;
          if (s.rateChangeForm.date) document.getElementById('rateChangeDate').value = s.rateChangeForm.date;
        }
        if (s.prepayForm) {
          if (s.prepayForm.amount) document.getElementById('prepayAmount').value = s.prepayForm.amount;
          if (s.prepayForm.date) document.getElementById('prepayDate').value = s.prepayForm.date;
        }
        if (s.firstPayDate) {
          document.getElementById('firstPayDate').value = s.firstPayDate;
        }
        renderChips();
      } catch (err) {
        console.warn('åŠ è½½æœ¬åœ°è®°å½•å¤±è´¥', err);
      }
    }

    function renderChips() {
      const rcDiv = document.getElementById('rateChanges');
      rcDiv.innerHTML = rateChanges.map((r, i) =>
        `<div class="chip">ç¬¬${r.period + 1}æœŸç”Ÿæ•ˆ (${r.date || 'æœªå¡«æ—¥æœŸ'}): å¹´åˆ©ç‡â†’${r.rate}% <button onclick="delRate(${i})" style="padding: 2px 5px; font-size: 10px;">åˆ é™¤</button></div>`
      ).join('');
      const ppDiv = document.getElementById('prepays');
      ppDiv.innerHTML = prepays.map((p, i) =>
        `<div class="chip">ç¬¬${p.period}æœŸå‰: æå‰è¿˜æ¬¾ ${p.amount.toLocaleString()} ${p.date ? `(${p.date})` : ''} <button onclick="delPrepay(${i})" style="padding: 2px 5px; font-size: 10px;">åˆ é™¤</button></div>`
      ).join('');
      saveState();
    }

    function addRateChange() {
      const rate = +document.getElementById('rateChangeValue').value;
      const date = document.getElementById('rateChangeDate').value;
      const firstPayDate = document.getElementById('firstPayDate').value;
      
      if (!date) {
        alert('è¯·å¡«å†™å˜æ›´ç”Ÿæ•ˆæ—¥æœŸ');
        return;
      }
      
      const dateObj = new Date(date);
      if (Number.isNaN(dateObj.getTime())) {
        alert('è¯·å¡«å†™æœ‰æ•ˆçš„å˜æ›´ç”Ÿæ•ˆæ—¥æœŸ');
        return;
      }
      
      if (!firstPayDate) {
        alert('è¯·å…ˆå¡«å†™é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸï¼Œä»¥ä¾¿è‡ªåŠ¨è®¡ç®—æœŸæ•°');
        return;
      }
      
      // æ ¹æ®æ—¥æœŸè‡ªåŠ¨è®¡ç®—æœŸæ•°
      const period = calcPeriodFromDate(firstPayDate, date);
      if (!period) {
        alert('æ— æ³•è®¡ç®—æœŸæ•°ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæ ¼å¼');
        return;
      }
      
      if (rate >= 0) {
        rateChanges.push({ period, rate, date });
        rateChanges.sort((a, b) => {
          const da = new Date(a.date).getTime();
          const db = new Date(b.date).getTime();
          return da === db ? a.period - b.period : da - db;
        });
        renderChips();
        saveState();
      }
    }
    function addPrepay() {
      const amount = +document.getElementById('prepayAmount').value;
      const date = document.getElementById('prepayDate').value;
      const firstPayDate = document.getElementById('firstPayDate').value;

      if (!date) {
        alert('è¯·å¡«å†™æå‰è¿˜æ¬¾æ—¥æœŸ');
        return;
      }

      const dateObj = new Date(date);
      if (Number.isNaN(dateObj.getTime())) {
        alert('è¯·å¡«å†™æœ‰æ•ˆçš„æå‰è¿˜æ¬¾æ—¥æœŸ');
        return;
      }

      if (!firstPayDate) {
        alert('è¯·å…ˆå¡«å†™é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸï¼Œä»¥ä¾¿è‡ªåŠ¨è®¡ç®—æœŸæ•°');
        return;
      }

      if (amount <= 0) {
        alert('è¯·å¡«å†™æœ‰æ•ˆçš„è¿˜æ¬¾é‡‘é¢');
        return;
      }

      // æ ¹æ®æ—¥æœŸè‡ªåŠ¨è®¡ç®—æœŸæ•°
      const calculatedPeriod = calcPeriodFromDate(firstPayDate, date);
      if (!calculatedPeriod) {
        alert('æ— æ³•è®¡ç®—æœŸæ•°ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæ ¼å¼');
        return;
      }

      // æå‰è¿˜æ¬¾çš„æœŸæ•°å°±æ˜¯è®¡ç®—å‡ºçš„æœŸæ•°ï¼ˆåœ¨è¯¥æœŸä¹‹å‰è¿˜æ¬¾ï¼‰
      const period = calculatedPeriod;
      const prepayData = { period, amount, date };
      prepays.push(prepayData);
      prepays.sort((a, b) => {
        // å…ˆæŒ‰æœŸæ•°æ’åºï¼Œå¦‚æœæœŸæ•°ç›¸åŒåˆ™æŒ‰æ—¥æœŸæ’åº
        if (a.period !== b.period) return a.period - b.period;
        const da = a.date ? new Date(a.date).getTime() : 0;
        const db = b.date ? new Date(b.date).getTime() : 0;
        return da - db;
      });
      renderChips();
      saveState();
    }
    function delRate(i) { rateChanges.splice(i, 1); renderChips(); saveState(); }
    function delPrepay(i) { prepays.splice(i, 1); renderChips(); saveState(); }

    function monthlyPayment(principal, annualRate, months) {
      const r = annualRate / 100 / 12;
      if (r === 0) return principal / months;
      return principal * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1);
    }

    function annuityMonths(balance, annualRate, payment) {
      if (payment <= 0) return Infinity;
      const r = annualRate / 100 / 12;
      if (r === 0) return balance / payment;
      const ratio = 1 - (r * balance) / payment;
      if (ratio <= 0) return 1;
      return -Math.log(ratio) / Math.log(1 + r);
    }

    // ä¼°ç®—åœ¨â€œä¸çŸ¥é“æœªæ¥å˜æ›´â€çš„è§†è§’ä¸‹ï¼Œåç»­åº”ä»˜çš„å…¨éƒ¨åˆ©æ¯
    // å‡è®¾ï¼šåç»­åˆ©ç‡ä¿æŒå½“å‰åˆ©ç‡ï¼›ä¸å†å‘ç”Ÿæ–°çš„æå‰è¿˜æ¬¾æˆ–åˆ©ç‡å˜æ›´
    function estimateRemainingInterest(balance, annualRate, remainingMonths, repayType) {
      if (remainingMonths <= 0 || balance <= 0) return 0;
      const r = annualRate / 100 / 12;
      if (repayType === 'annuity') {
        const pay = monthlyPayment(balance, annualRate, remainingMonths);
        const total = pay * remainingMonths;
        return Math.max(total - balance, 0);
      }
      // ç­‰é¢æœ¬é‡‘ï¼šåˆ©æ¯ä¸ºé€’å‡ç­‰å·®æ•°åˆ—
      const principalPerMonth = balance / remainingMonths;
      // åˆ©æ¯æ€»å’Œ = r * [remainingMonths * balance - principalPerMonth * remainingMonths * (remainingMonths - 1) / 2]
      const interestSum = r * (remainingMonths * balance - principalPerMonth * remainingMonths * (remainingMonths - 1) / 2);
      return Math.max(interestSum, 0);
    }

    function parseDate(value) {
      const d = new Date(value);
      return isNaN(d.getTime()) ? null : d;
    }

    function buildRateTimeline(initialRate, firstPayDateStr, rateChangesList) {
      const firstDate = parseDate(firstPayDateStr);
      const startDate = addMonthsWithClamp(firstDate, -1); // ä»é¦–æœŸå‰ä¸€æœˆå¼€å§‹ç´¯è®¡åˆ©æ¯
      const timeline = [{ date: startDate, rate: initialRate }];
      rateChangesList.forEach(r => {
        const d = parseDate(r.date);
        if (d) timeline.push({ date: d, rate: r.rate });
      });
      timeline.sort((a, b) => a.date - b.date);
      return timeline;
    }

    function rateAtDate(timeline, date) {
      let current = timeline[0].rate;
      for (const item of timeline) {
        if (date >= item.date) current = item.rate;
        else break;
      }
      return current;
    }

    // åˆ¤æ–­ä¸€ä¸ªè®¡æ¯åŒºé—´å†…æ˜¯å¦å­˜åœ¨åˆ©ç‡å˜åŠ¨ï¼ˆä¸å«ç«¯ç‚¹ï¼‰
    function hasRateChangeBetween(timeline, startDate, endDate) {
      for (const item of timeline) {
        if (item.date > startDate && item.date < endDate) return true;
        if (item.date >= endDate) break;
      }
      return false;
    }

    function interestByDays(balance, startDate, endDate, timeline) {
      if (!(startDate && endDate)) return 0;

      // æ£€æŸ¥æ˜¯å¦ä¸ºåˆ©ç‡å˜æ›´æœˆï¼ˆè¯¥æœˆå†…æœ‰åˆ©ç‡å˜æ›´ï¼‰
      const hasRateChangeInMonth = timeline.some(item => {
        return item.date > startDate && item.date <= endDate;
      });

      if (hasRateChangeInMonth) {
        // åˆ©ç‡å˜æ›´æœˆï¼šæŒ‰å›ºå®š30å¤©è®¡ç®—
        return interestForRateChangeMonth(balance, startDate, endDate, timeline);
      } else {
        // æ™®é€šæœˆï¼šæœˆåˆ©ç‡è®¡ç®—
        const rate = rateAtDate(timeline, startDate);
        return balance * (rate / 100) / 12; // æœˆåˆ©ç‡
      }
    }

    function interestForRateChangeMonth(balance, startDate, endDate, timeline) {
      // åˆ©ç‡å˜æ›´æœˆæŒ‰å›ºå®š30å¤©è®¡ç®—
      const sortedTimeline = [...timeline].sort((a, b) => a.date - b.date);

      // æ‰¾åˆ°è¯¥æœˆå†…çš„åˆ©ç‡å˜æ›´æ—¥
      const rateChangeDate = sortedTimeline.find(item =>
        item.date > startDate && item.date <= endDate
      )?.date;

      if (!rateChangeDate) {
        // æ²¡æœ‰åˆ©ç‡å˜æ›´ï¼ŒæŒ‰æ™®é€šæœˆè®¡ç®—
        const rate = rateAtDate(timeline, startDate);
        return balance * (rate / 100) / 12;
      }

      // è®¡ç®—ä»ä¸Šä¸€æ¬¡è¿˜æ¬¾æ—¥åˆ°åˆ©ç‡ç”Ÿæ•ˆæ—¥çš„å¤©æ•°
      const ONE_DAY = 24 * 60 * 60 * 1000;
      const oldRateDays = Math.round((rateChangeDate - startDate) / ONE_DAY) - 1;

      // æ–°åˆ©ç‡å¤©æ•°ï¼šå›ºå®š30å¤© - æ—§åˆ©ç‡å¤©æ•°
      const newRateDays = 30 - oldRateDays;

      const oldRate = rateAtDate(timeline, startDate);
      const newRate = rateAtDate(timeline, rateChangeDate);

      // æœˆåˆ©ç‡/30å¤©è®¡ç®—æ–¹å¼
      const oldInterest = balance * (oldRate / 100) / 12 * (oldRateDays / 30);
      const newInterest = balance * (newRate / 100) / 12 * (newRateDays / 30);

      return oldInterest + newInterest;
    }

    function periodRange(firstPayDate, periodIndex) {
      const dueDate = addMonthsWithClamp(firstPayDate, periodIndex - 1);
      const startDate = periodIndex === 1
        ? addMonthsWithClamp(firstPayDate, -1)
        : addMonthsWithClamp(firstPayDate, periodIndex - 2);
      return { startDate, endDate: dueDate };
    }

    function buildSchedule(P0, annualRateInit, monthsInit, repayType, prepayMode, rateChangesList, prepaysList, firstPayDateStr) {
      const firstPayDate = parseDate(firstPayDateStr);
      if (!firstPayDate) return { schedule: [] };
      const timeline = buildRateTimeline(annualRateInit, firstPayDateStr, rateChangesList);
      let monthsTotal = monthsInit;
      let balance = P0;
      let schedule = [];
      let currentMonth = 1;
      let remainingMonths = monthsTotal;
      let lockedPayment = null; // ç”¨äºâ€œä¿æŒæœˆä¾›â€æ¨¡å¼çš„ç­‰é¢æœ¬æ¯
      let lockedPrincipalEP = null; // ç”¨äºâ€œä¿æŒæœˆä¾›â€æ¨¡å¼çš„ç­‰é¢æœ¬é‡‘ï¼ˆä¿æŒæ¯æœˆæœ¬é‡‘éƒ¨åˆ†ï¼‰

      // å°†æå‰è¿˜æ¬¾æŒ‰æœŸæ•°åˆ†ç»„ï¼Œæ”¯æŒåŒä¸€æœŸå¤šæ¬¡æå‰è¿˜æ¬¾
      const prepayMap = new Map();
      prepaysList.forEach(p => {
        if (!prepayMap.has(p.period)) {
          prepayMap.set(p.period, []);
        }
        prepayMap.get(p.period).push(p);
      });

      // å¯¹æ¯æœŸå†…çš„æå‰è¿˜æ¬¾æŒ‰æ—¥æœŸæ’åº
      prepayMap.forEach(prepays => {
        prepays.sort((a, b) => {
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return new Date(a.date) - new Date(b.date);
        });
      });

      while (balance > 0.01 && remainingMonths > 0 && currentMonth <= monthsTotal) {
        const { startDate, endDate } = periodRange(firstPayDate, currentMonth);
        const effectiveRate = rateAtDate(timeline, startDate);
        let pay;
        // æ— åˆ©ç‡å˜åŠ¨æ—¶æŒ‰æœˆè®¡æ¯ï¼›å‘ç”Ÿå˜åŠ¨æ—¶æŒ‰å¤©æ‹†åˆ†
        let interest;
        if (hasRateChangeBetween(timeline, startDate, endDate)) {
          interest = interestByDays(balance, startDate, endDate, timeline);
        } else {
          interest = balance * (effectiveRate / 100) / 12;
        }
        let principalPay;
        // ç”¨äºå¤‡æ³¨å±•ç¤ºçš„è¯´æ˜
        let noteParts = [];

        if (repayType === 'annuity') {
          // å¯¹äºåˆ©ç‡å˜æ›´æœˆï¼Œä½¿ç”¨æœŸæœ«åˆ©ç‡è®¡ç®—æœˆä¾›
          const rateForPayment = hasRateChangeBetween(timeline, startDate, endDate)
            ? rateAtDate(timeline, endDate)
            : effectiveRate;
          pay = lockedPayment ?? monthlyPayment(balance, rateForPayment, remainingMonths);
          principalPay = pay - interest;
        } else {
          const principalBase = lockedPrincipalEP ?? (balance / remainingMonths);
          principalPay = principalBase;
          pay = principalPay + interest;
        }
        // æœ¬æœŸç»“æŸåå‰©ä½™æœŸæ•°ï¼ˆç”¨äºä¼°ç®—åç»­åˆ©æ¯ï¼‰
        const remainingAfterThis = Math.max(remainingMonths - 1, 0);

        // å…ˆå¤„ç†æ­£å¸¸è¿˜æ¬¾
        balance -= principalPay;
        if (balance < 0) {
          principalPay += balance;
          balance = 0;
        }
        remainingMonths = remainingAfterThis;

        const rateChangedThisPeriod = rateChangesList
          .some(r => {
            const d = parseDate(r.date);
            return d && d > startDate && d <= endDate;
          });
        const rateBeforeChange = rateAtDate(timeline, startDate);
        const rateAfterChange = rateAtDate(timeline, endDate);

        if (rateChangedThisPeriod) {
          const baseRemainingInterest = estimateRemainingInterest(balance, rateBeforeChange, remainingAfterThis, repayType);
          const newRemainingInterest = estimateRemainingInterest(balance, rateAfterChange, remainingAfterThis, repayType);
          const saved = baseRemainingInterest - newRemainingInterest;
          noteParts.push(`åˆ©ç‡å˜æ›´${rateAfterChange}%`);
          if (Number.isFinite(saved)) {
            noteParts.push(`èŠ‚çœåˆ©æ¯â‰ˆ${saved.toFixed(2)}`);
          }
        }

        schedule.push({
          period: currentMonth,
          payment: pay,
          principal: principalPay,
          interest,
          prepay: 0,
          rate: rateAtDate(timeline, endDate),
          balance: balance,
          rateChanged: rateChangedThisPeriod,
          note: noteParts.join('; ')
        });

        // æ£€æŸ¥ä¸‹ä¸€æœŸæ˜¯å¦æœ‰æå‰è¿˜æ¬¾ï¼ˆåœ¨ä¸‹ä¸€æœŸè¿˜æ¬¾æ—¥ä¹‹å‰ï¼‰
        const nextMonth = currentMonth + 1;
        if (prepayMap.has(nextMonth)) {
          const prepayList = prepayMap.get(nextMonth);
          const lastNormalPayDate = endDate; // ä¸Šæ¬¡æ­£å¸¸è¿˜æ¬¾æ—¥æœŸï¼ˆå§‹ç»ˆä¸å˜ï¼‰

          // å¤„ç†è¯¥æœŸå†…çš„æ‰€æœ‰æå‰è¿˜æ¬¾
          prepayList.forEach((prepayInfo, index) => {
            const extra = prepayInfo.amount;

            // è®¡ç®—æå‰è¿˜æ¬¾åˆ©æ¯
            let daysSinceLastPay = 15; // é»˜è®¤15å¤©ï¼ˆå‡è®¾åœ¨æœˆä¸­æå‰è¿˜æ¬¾ï¼‰
            let prepayDate = null;
            let prepayRate = effectiveRate; // é»˜è®¤ä½¿ç”¨å½“æœŸåˆ©ç‡

            if (prepayInfo.date) {
              // å§‹ç»ˆä»ä¸Šæ¬¡æ­£å¸¸è¿˜æ¬¾æ—¥è®¡ç®—åˆ°æå‰è¿˜æ¬¾æ—¥çš„å¤©æ•°
              prepayDate = parseDate(prepayInfo.date);
              const ONE_DAY = 24 * 60 * 60 * 1000;

              if (prepayDate && lastNormalPayDate) {
                daysSinceLastPay = Math.round((prepayDate - lastNormalPayDate) / ONE_DAY);
                // åŒ…å«å½“å¤©ï¼Œè¶…è¿‡30å¤©æŒ‰30å¤©ç®—ï¼Œç­‰äºå¤§äºå½“å‰æœˆçš„å¤©æ•°ä¹Ÿç®—30å¤©
                daysSinceLastPay = Math.max(1, Math.min(daysSinceLastPay, 30));

                // å¦‚æœå½“å‰æœˆå¤©æ•°ä¸è¶³30å¤©ï¼Œä¹ŸæŒ‰30å¤©ç®—
                const currentMonthDays = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
                if (daysSinceLastPay >= currentMonthDays) {
                  daysSinceLastPay = 30;
                }
                // è·å–æå‰è¿˜æ¬¾æ—¥æœŸå½“æ—¶çš„åˆ©ç‡
                prepayRate = rateAtDate(timeline, prepayDate);
              }
            } else {
              // å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¥æœŸï¼Œå‡è®¾æ¯æ¬¡æå‰è¿˜æ¬¾éƒ½æ˜¯ä»ä¸Šæ¬¡æ­£å¸¸è¿˜æ¬¾æ—¥å¼€å§‹è®¡ç®—
              // å¯ä»¥æ ¹æ®åºå·è®¾ç½®ä¸åŒçš„é»˜è®¤å¤©æ•°
              daysSinceLastPay = 15 + (index * 5); // ç¬¬ä¸€æ¬¡15å¤©ï¼Œç¬¬äºŒæ¬¡20å¤©ï¼Œç¬¬ä¸‰æ¬¡25å¤©ç­‰
            }

            // æå‰è¿˜æ¬¾åˆ©æ¯ = è¿˜æ¬¾é‡‘é¢ * æå‰è¿˜æ¬¾æ—¥å½“æ—¶çš„åˆ©ç‡ / 12 * å¤©æ•° / 30
            const prepayInterest = extra * (prepayRate / 100) / 12 * daysSinceLastPay / 30;

            const beforeBalance = balance;
            balance -= extra;
            if (balance < 0) balance = 0;
            const baseRemainingInterest = estimateRemainingInterest(beforeBalance, prepayRate, remainingMonths, repayType);
            const newRemainingInterest = estimateRemainingInterest(balance, prepayRate, remainingMonths, repayType);
            const savedInterest = baseRemainingInterest - newRemainingInterest;

            // åªåœ¨æœ€åä¸€æ¬¡æå‰è¿˜æ¬¾æ—¶é‡æ–°è®¡ç®—æœŸæ•°
            if (index === prepayList.length - 1) {
              // ç»Ÿä¸€ä¸ºâ€œä¿æŒæœŸæ•°ï¼Œé™ä½æœˆä¾›â€æ¨¡å¼ï¼Œç§»é™¤ç¼©çŸ­æœŸæ•°é€»è¾‘
              lockedPayment = null;
              lockedPrincipalEP = null;
            }

            // æ·»åŠ æå‰è¿˜æ¬¾è¡Œï¼ˆåœ¨ç¬¬nextMonthæœŸä¹‹å‰ï¼‰
            const prepaySequence = prepayList.length > 1 ? `-${index + 1}` : '';
            schedule.push({
              period: `${nextMonth}P${prepaySequence}`, // ç”¨Pæ ‡è¯†æå‰è¿˜æ¬¾ï¼Œå¤šæ¬¡è¿˜æ¬¾ç”¨åºå·åŒºåˆ†
              payment: extra + prepayInterest,
              principal: extra,
              interest: prepayInterest,
              prepay: extra,
              rate: prepayRate, // ä½¿ç”¨æå‰è¿˜æ¬¾æ—¥å½“æ—¶çš„åˆ©ç‡
              balance: balance,
              prepayDate: prepayInfo.date, // ä¿å­˜æå‰è¿˜æ¬¾æ—¥æœŸ
              note: [
                `æå‰è¿˜æ¬¾${extra.toLocaleString()}`,
                Number.isFinite(savedInterest) ? `èŠ‚çœåˆ©æ¯â‰ˆ${savedInterest.toFixed(2)}` : ''
              ].filter(Boolean).join('; ')
            });
          });
        }


        currentMonth++;
      }

      return { schedule };
    }

    function calc() {
      const P0 = +document.getElementById('principal').value;
      const annualRateInput = +document.getElementById('annualRate').value;
      const monthsInput = +document.getElementById('months').value;
      const repayType = document.getElementById('repayType').value;
      const prepayMode = document.getElementById('prepayMode')?.value || 'reducePayment';
      const firstPayDate = document.getElementById('firstPayDate').value;
      if (!firstPayDate) {
        alert('è¯·å…ˆå¡«å†™é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸï¼Œä»¥ä¾¿æŒ‰æ—¥è®¡ç®—åˆ©æ¯');
        return;
      }
      saveState();

      // åŒºåˆ†å·²åˆ°æœŸå’Œæœªæ¥çš„æå‰è¿˜æ¬¾
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const effectivePrepays = prepays.filter(p => {
        if (!p.date) return true;
        const d = parseDate(p.date);
        if (!d) return true;
        return d <= today;
      });
      const futurePrepays = prepays.filter(p => {
        if (!p.date) return false;
        const d = parseDate(p.date);
        if (!d) return false;
        return d > today;
      });

      // è®¡ç®—å®é™…è¿˜æ¬¾è®¡åˆ’ï¼ˆåªåŒ…å«å·²åˆ°æœŸçš„æå‰è¿˜æ¬¾ï¼‰
      const activeSchedule = buildSchedule(P0, annualRateInput, monthsInput, repayType, prepayMode, rateChanges, effectivePrepays, firstPayDate);

      // è®¡ç®—åŒ…å«æœªæ¥æå‰è¿˜æ¬¾çš„å®Œæ•´è®¡åˆ’ï¼ˆç”¨äºè¡¨æ ¼å±•ç¤ºï¼‰
      const fullSchedule = buildSchedule(P0, annualRateInput, monthsInput, repayType, prepayMode, rateChanges, prepays, firstPayDate);

      // ç›´æ¥ä½¿ç”¨å®é™…è¿˜æ¬¾åˆ—è¡¨ä¸­çš„æ”¯ä»˜å€¼ï¼Œé¿å…é‡å¤è®¡å…¥æå‰è¿˜æ¬¾æœ¬é‡‘
      const totalPayment = activeSchedule.schedule.reduce((sum, s) => sum + s.payment, 0);
      const totalInterest = activeSchedule.schedule.reduce((sum, s) => sum + s.interest, 0);
      
      renderResult(fullSchedule.schedule, {
        principal: P0,
        totalPayment,
        totalInterest,
        firstPayDate,
        months: monthsInput,
        repayType,
        annualRate: annualRateInput
      }, futurePrepays);
    }

    function addMonthsWithClamp(date, months) {
      const d = new Date(date.getTime());
      const targetMonth = d.getMonth() + months;
      const day = d.getDate();
      d.setDate(1);
      d.setMonth(targetMonth);
      const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
      d.setDate(Math.min(day, lastDay));
      return d;
    }

    function calcPeriodFromDate(firstPayDateStr, targetDateStr) {
      
      if (!firstPayDateStr || !targetDateStr) return null;
      const start = new Date(firstPayDateStr);
      const target = new Date(targetDateStr);
      if (isNaN(start.getTime()) || isNaN(target.getTime())) return null;
      if (target < start) return 1; // å¦‚æœå˜æ›´æ—¥æœŸåœ¨é¦–æ¬¡è¿˜æ¬¾æ—¥ä¹‹å‰ï¼Œé»˜è®¤ä¸ºç¬¬1æœŸ
      
      // è®¡ç®—æœˆä»½å·®
      const monthsDiff = (target.getFullYear() - start.getFullYear()) * 12 + (target.getMonth() - start.getMonth());
      let period = monthsDiff + 1;
      
      // è®¡ç®—è¯¥æœŸå¯¹åº”çš„è¿˜æ¬¾æ—¥
      const periodPayDate = new Date(start.getFullYear(), start.getMonth() + monthsDiff, start.getDate());
      
      // å¦‚æœç›®æ ‡æ—¥æœŸåœ¨è¯¥æœŸè¿˜æ¬¾æ—¥ä¹‹å‰ï¼Œç®—ä½œè¯¥æœŸï¼›å¦åˆ™ç®—ä½œä¸‹ä¸€æœŸ
      period = monthsDiff + 1;
      if (period < 1) period = 1;
      return period;
    }

    function calcCurrentPeriod(firstPayDateStr, totalPeriods) {
      if (!firstPayDateStr) return null;
      const start = new Date(firstPayDateStr);
      if (isNaN(start)) return null;
      const today = new Date();
      if (today < start) return 0;
      const monthsDiff = (today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth());
      let period = monthsDiff + 1;
      if (today.getDate() < start.getDate()) period -= 1;
      if (period < 0) period = 0;
      if (totalPeriods !== undefined) period = Math.min(period, totalPeriods);
      return period;
    }

    function renderResult(schedule, summary, futurePrepays = []) {
      const container = document.getElementById('result');
      if (!schedule.length) {
        container.innerHTML = '<p>æ— ç»“æœ</p>';
        return;
      }
      const fmt = (v) => v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const principalPaid = schedule.reduce((sum, s) => sum + s.principal + (s.prepay || 0), 0);
      const interestPaid = schedule.reduce((sum, s) => sum + s.interest, 0);
      const startDate = summary.firstPayDate ? new Date(summary.firstPayDate) : null;
      const currentPeriod = calcCurrentPeriod(summary.firstPayDate, schedule.length);
      
      // åˆ¤æ–­æŸä¸ªæ—¥æœŸæ˜¯å¦ä¸ºæœªæ¥
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const isFutureDate = (dateStr) => {
        if (!dateStr) return false;
        const d = parseDate(dateStr);
        return d && d > today;
      };
      
      const remainingBalance = (() => {
        if (currentPeriod === null) return summary.principal;
        if (currentPeriod <= 0) return summary.principal;
        // ä¼˜å…ˆç”¨åˆ—è¡¨ä¸­å½“å‰æœŸå¯¹åº”çš„ä½™é¢ï¼Œé¿å…é¢„ä»˜æ¬¾è¡Œå¯¼è‡´ç´¢å¼•é”™ä½
        const matched = schedule.find(s => typeof s.period === 'number' && s.period === currentPeriod);
        if (matched) return Math.max(matched.balance, 0);
        const idx = Math.min(currentPeriod - 1, schedule.length - 1);
        return Math.max(schedule[idx].balance, 0);
      })();
      const paidThroughCurrent = (() => {
        if (currentPeriod === null) return 0;
        if (currentPeriod <= 0) return 0;
        // ä»…ç»Ÿè®¡å·²åˆ°æœŸçš„å®Œæ•´æœŸæ¬¡ï¼Œå½“å‰æœŸæœªåˆ°è¿˜æ¬¾æ—¥ä¸è®¡å…¥
        const upto = Math.max(Math.min(currentPeriod - 1, schedule.length), 0);
        return schedule.slice(0, upto).reduce((sum, s) => sum + s.payment, 0);
      })();
      const interestThroughCurrent = (() => {
        if (currentPeriod === null) return 0;
        if (currentPeriod <= 0) return 0;
        const upto = Math.max(Math.min(currentPeriod - 1, schedule.length), 0);
        return schedule.slice(0, upto).reduce((sum, s) => sum + s.interest, 0);
      })();
      const remainingInterest = (() => {
        if (currentPeriod === null) return summary.totalInterest;
        if (currentPeriod <= 0) return summary.totalInterest;
        // ä¸å‰©ä½™æœ¬é‡‘åŒç†ï¼Œä¼˜å…ˆç”¨åˆ—è¡¨ä¸­å½“å‰æœŸçš„è¡Œåšåˆ‡åˆ†ï¼Œé¿å…æå‰è¿˜æ¬¾è¡Œé”™ä½
        const matchedIndex = schedule.findIndex(s => typeof s.period === 'number' && s.period === currentPeriod);
        const startIdx = matchedIndex >= 0
          ? matchedIndex
          : Math.max(Math.min(currentPeriod - 1, schedule.length - 1), 0);
        return Math.max(schedule.slice(startIdx).reduce((sum, s) => sum + s.interest, 0), 0);
      })();
      // å‰©ä½™é‡‘é¢ = å‰©ä½™æœ¬é‡‘ + å‰©ä½™åˆ©æ¯ï¼Œä¿æŒä¸ä¸¤é¡¹ä¹‹å’Œä¸€è‡´
      const remainingPayment = Math.max(remainingBalance + remainingInterest, 0);

      let accumulatedInterest = 0;
      const rows = schedule.map((s, index) => {
        // å¤„ç†æå‰è¿˜æ¬¾è¡Œçš„æœŸæ•°æ˜¾ç¤º
        const isPrepayRow = typeof s.period === 'string' && s.period.includes('P');
        let periodDisplay = s.period;
        let dueDate = null;
        let dueDateStr = '-';
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºæœªæ¥çš„æå‰è¿˜æ¬¾
        const isFuturePrepay = isPrepayRow && s.prepayDate && isFutureDate(s.prepayDate);

        if (isPrepayRow) {
          // æå‰è¿˜æ¬¾è¡Œæ˜¾ç¤ºä¸º "ç¬¬XæœŸå†…æå‰è¿˜æ¬¾" æˆ– "ç¬¬XæœŸå†…æå‰è¿˜æ¬¾-N"
          const periodParts = s.period.split('P');
          const basePeriod = parseInt(periodParts[0]);
          const sequence = periodParts[1] || '';
          periodDisplay = basePeriod;
          // ä½¿ç”¨å®é™…çš„æå‰è¿˜æ¬¾æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
          if (s.prepayDate) {
            dueDateStr = s.prepayDate;
          } else {
            dueDateStr = 'æå‰è¿˜æ¬¾æ—¥';
          }
        } else {
          // æ­£å¸¸è¿˜æ¬¾è¡Œ
          dueDate = startDate ? addMonthsWithClamp(startDate, s.period - 1) : null;
          dueDateStr = dueDate ? `${dueDate.getFullYear()}-${String(dueDate.getMonth() + 1).padStart(2, '0')}-${String(dueDate.getDate()).padStart(2, '0')}` : '-';
        }

        // ç´¯è®¡å·²è¿˜åˆ©æ¯ï¼ˆåŒ…æ‹¬å½“å‰è¡Œï¼‰
        accumulatedInterest += s.interest;
        
        // å‰©ä½™åˆ©æ¯ï¼šåŸºäºå½“å‰è¡Œçš„å‰©ä½™æœ¬é‡‘å’Œåˆ©ç‡ï¼Œä¼°ç®—æœªæ¥éœ€è¦æ”¯ä»˜çš„åˆ©æ¯
        // ä¸ä½¿ç”¨åç»­å®é™…åˆ©æ¯ç´¯åŠ ï¼Œå› ä¸ºé‚£æ ·ä¼šè®©æœªæ¥çš„æå‰è¿˜æ¬¾å½±å“å½“å‰è¡Œçš„æ˜¾ç¤º
        // ä½¿ç”¨estimateRemainingInterestå‡½æ•°ï¼ŒåŸºäºå½“å‰çŠ¶æ€ä¼°ç®—
        const currentBalance = s.balance;
        const currentRate = s.rate;
        
        // è®¡ç®—å‰©ä½™æœŸæ•°ï¼šæ‰¾åˆ°å½“å‰è¡Œä¹‹åè¿˜æœ‰å¤šå°‘ä¸ªæ­£å¸¸è¿˜æ¬¾æœŸ
        const remainingNormalPeriods = schedule.slice(index + 1).filter(item => typeof item.period === 'number').length;
        
        const remainingInterestForRow = estimateRemainingInterest(
          currentBalance, 
          currentRate, 
          remainingNormalPeriods, 
          summary.repayType
        );

        const highlight = currentPeriod && s.period === currentPeriod ? ' class="current-row"' : '';
        const styles = [];
        if (isPrepayRow) styles.push('background-color: #fff7ed;');
        if (s.rateChanged) styles.push('background-color: #fff7ed;');
        if (isFuturePrepay) styles.push('background-color: #e0f2fe; opacity: 0.8;'); // æœªæ¥æå‰è¿˜æ¬¾ç”¨è“è‰²èƒŒæ™¯
        const styleAttr = styles.length ? ` style="${styles.join(' ')}"` : '';
        
        // æœªæ¥æå‰è¿˜æ¬¾çš„å¤‡æ³¨æ·»åŠ æ ‡è¯†
        const noteText = isFuturePrepay ? `ã€è®¡åˆ’ã€‘${s.note || ''}` : (s.note || '');

        return `
        <tr${highlight}${styleAttr}>
          <td>${periodDisplay}</td>
          <td>${dueDateStr}</td>
          <td>${s.rate.toFixed(3)}%</td>
          <td>${s.payment.toFixed(2)}</td>
          <td>${s.principal.toFixed(2)}</td>
          <td>${s.interest.toFixed(2)}</td>
          <td>${s.balance.toFixed(2)}</td>
          <td>${remainingInterestForRow.toFixed(2)}</td>
          <td class="note">${noteText}</td>
        </tr>`;
      }).join('');

      const currentText = (() => {
        if (currentPeriod === null) return 'æœªå¡«å†™é¦–æ¬¡è¿˜æ¬¾æ—¥';
        if (currentPeriod === 0) return 'æœªåˆ°é¦–æ¬¡è¿˜æ¬¾æ—¥';
        return `å½“å‰æ—¥æœŸå¯¹åº”ç¬¬ ${currentPeriod} æœŸ`;
      })();

      container.innerHTML = `
        <div class="summary-grid">
          <div class="summary-card">
            <p class="summary-title">å‰©ä½™é‡‘é¢/æ€»é‡‘é¢</p>
            <p class="summary-value">${fmt(remainingPayment)} / ${fmt(summary.totalPayment)}</p>
          </div>
          <div class="summary-card">
            <p class="summary-title">å‰©ä½™æœ¬é‡‘/æ€»æœ¬é‡‘</p>
            <p class="summary-value">${fmt(remainingBalance)} / ${fmt(summary.principal)}</p>
          </div>
       
          <div class="summary-card">
            <p class="summary-title">å‰©ä½™åˆ©æ¯/æ€»åˆ©æ¯</p>
            <p class="summary-value">${fmt(remainingInterest)} / ${fmt(summary.totalInterest)}</p>
          </div>
          <div class="summary-card">
            <p class="summary-title">å½“å‰æœŸæ•°ï¼ˆæŒ‰æ—¥ï¼‰</p>
            <p class="summary-value">${currentText}</p>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>æœŸæ•°</th><th>åº”è¿˜æ—¥æœŸ</th><th>å¹´åˆ©ç‡</th><th>å½“æœŸæœˆä¾›</th><th>æœ¬é‡‘</th><th>åˆ©æ¯</th><th>å‰©ä½™æœ¬é‡‘</th><th>å‰©ä½™åˆ©æ¯</th><th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;

      // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨å¹¶æ¸²æŸ“å›¾è¡¨ï¼ˆåŒ…å«æœªæ¥è®¡åˆ’çš„æå‰è¿˜æ¬¾ï¼‰
      document.getElementById('chartsContainer').style.display = 'block';
      renderCharts(schedule, summary, currentPeriod, remainingBalance, remainingInterest);
    }

    function bindAutoSave() {
      ['principal', 'annualRate', 'months', 'rateChangeValue', 'rateChangeDate', 'prepayAmount', 'prepayDate', 'firstPayDate']
        .forEach(id => {
          const el = document.getElementById(id);
          el.addEventListener('input', saveState);
        });
      document.getElementById('repayType')?.addEventListener('change', saveState);
      document.getElementById('prepayMode')?.addEventListener('change', saveState);
    }

    // å›¾è¡¨å®ä¾‹å­˜å‚¨
    let chartInstances = {};

    // é”€æ¯ç°æœ‰å›¾è¡¨
    function destroyExistingCharts() {
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
      chartInstances = {};
    }

    // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
    function renderCharts(schedule, summary, currentPeriod, remainingBalance, remainingInterest) {
      destroyExistingCharts();
      
      // è¿‡æ»¤æ‰æå‰è¿˜æ¬¾è¡Œï¼Œåªä¿ç•™æ­£å¸¸è¿˜æ¬¾æœŸæ•°
      const normalSchedule = schedule.filter(s => typeof s.period === 'number');
      
      renderPaymentTrendChart(normalSchedule);
      renderPrepayEffectChart(schedule);
      renderYearlyAnalysisChart(normalSchedule, summary);
      updatePredictionCards(schedule, summary, currentPeriod, remainingBalance, remainingInterest);
    }

    // 1. è¿˜æ¬¾è¶‹åŠ¿å›¾
    function renderPaymentTrendChart(schedule) {
      const ctx = document.getElementById('paymentTrendChart').getContext('2d');
      const labels = schedule.map(s => `ç¬¬${s.period}æœŸ`);
      const payments = schedule.map(s => s.payment);
      const principals = schedule.map(s => s.principal);
      const interests = schedule.map(s => s.interest);

      chartInstances.paymentTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.slice(0, Math.min(60, labels.length)), // åªæ˜¾ç¤ºå‰60æœŸ
          datasets: [{
            label: 'æœˆä¾›æ€»é¢',
            data: payments.slice(0, Math.min(60, payments.length)),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.1
          }, {
            label: 'æœ¬é‡‘éƒ¨åˆ†',
            data: principals.slice(0, Math.min(60, principals.length)),
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            tension: 0.1
          }, {
            label: 'åˆ©æ¯éƒ¨åˆ†',
            data: interests.slice(0, Math.min(60, interests.length)),
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220, 38, 38, 0.1)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // æå‰è¿˜æ¬¾æ•ˆæœ
    function renderPrepayEffectChart(schedule) {
      const ctx = document.getElementById('prepayEffectChart').getContext('2d');
      
      // æå–æå‰è¿˜æ¬¾æ•°æ®
      const prepayData = schedule.filter(s => typeof s.period === 'string' && s.period.includes('P'));
      
      if (prepayData.length === 0) {
        // å¦‚æœæ²¡æœ‰æå‰è¿˜æ¬¾ï¼Œæ˜¾ç¤ºæç¤º
        chartInstances.prepayEffect = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['æš‚æ— æå‰è¿˜æ¬¾'],
            datasets: [{
              label: 'æå‰è¿˜æ¬¾é‡‘é¢',
              data: [0],
              backgroundColor: '#e5e7eb'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            }
          }
        });
        return;
      }

      const labels = prepayData.map((s, i) => `ç¬¬${i + 1}æ¬¡`);
      const amounts = prepayData.map(s => s.prepay || 0);
      const savings = prepayData.map(s => {
        if (s.note && s.note.includes('èŠ‚çœåˆ©æ¯')) {
          const match = s.note.match(/èŠ‚çœåˆ©æ¯â‰ˆ([\d.]+)/);
          return match ? parseFloat(match[1]) : 0;
        }
        return 0;
      });

      chartInstances.prepayEffect = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'æå‰è¿˜æ¬¾é‡‘é¢',
            data: amounts,
            backgroundColor: '#3b82f6',
            yAxisID: 'y'
          }, {
            label: 'èŠ‚çœåˆ©æ¯',
            data: savings,
            backgroundColor: '#10b981',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              position: 'left',
              title: { display: true, text: 'è¿˜æ¬¾é‡‘é¢ (å…ƒ)' },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: { display: true, text: 'èŠ‚çœåˆ©æ¯ (å…ƒ)' },
              grid: { drawOnChartArea: false },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // å¹´åº¦æ±‡æ€»åˆ†æ
    function renderYearlyAnalysisChart(schedule, summary) {
      const ctx = document.getElementById('yearlyAnalysisChart').getContext('2d');
      
      // æŒ‰å¹´ä»½æ±‡æ€»æ•°æ®
      const startDate = new Date(summary.firstPayDate);
      const yearlyData = {};
      
      schedule.forEach(s => {
        const periodDate = addMonthsWithClamp(startDate, s.period - 1);
        const year = periodDate.getFullYear();
        
        if (!yearlyData[year]) {
          yearlyData[year] = { payment: 0, principal: 0, interest: 0 };
        }
        
        yearlyData[year].payment += s.payment;
        yearlyData[year].principal += s.principal;
        yearlyData[year].interest += s.interest;
      });

      const years = Object.keys(yearlyData).sort();
      const payments = years.map(year => yearlyData[year].payment);
      const principals = years.map(year => yearlyData[year].principal);
      const interests = years.map(year => yearlyData[year].interest);

      chartInstances.yearlyAnalysis = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [{
            label: 'å¹´åº¦æœ¬é‡‘',
            data: principals,
            backgroundColor: '#059669',
            stack: 'Stack 0'
          }, {
            label: 'å¹´åº¦åˆ©æ¯',
            data: interests,
            backgroundColor: '#dc2626',
            stack: 'Stack 0'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              stacked: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            x: {
              stacked: true
            }
          }
        }
      });
    }

    // æ›´æ–°é¢„æµ‹å¡ç‰‡
    function updatePredictionCards(schedule, summary, currentPeriod, remainingBalance, remainingInterest) {
      const normalSchedule = schedule.filter(s => typeof s.period === 'number');
      const lastPeriod = normalSchedule[normalSchedule.length - 1];
      
      // é¢„è®¡å®Œæˆæ—¶é—´
      if (lastPeriod) {
        const startDate = new Date(summary.firstPayDate);
        const endDate = addMonthsWithClamp(startDate, lastPeriod.period - 1);
        document.getElementById('predictedEndDate').textContent = 
          `${endDate.getFullYear()}å¹´${endDate.getMonth() + 1}æœˆ`;
      }
      
      // å‰©ä½™æ€»åˆ©æ¯
      document.getElementById('remainingInterest').textContent = 
        `Â¥${remainingInterest.toLocaleString()}`;
      
      // æœˆå‡è¿˜æ¬¾
      const avgPayment = normalSchedule.reduce((sum, s) => sum + s.payment, 0) / normalSchedule.length;
      document.getElementById('avgMonthlyPayment').textContent = 
        `Â¥${avgPayment.toLocaleString()}`;
      
      // å…³é”®æŒ‡æ ‡
      const totalPayment = summary.totalPayment;
      const interestRatio = ((summary.totalInterest / totalPayment) * 100).toFixed(1);
      document.getElementById('interestRatio').textContent = `${interestRatio}%`;
      
      const progress = currentPeriod ? ((currentPeriod / normalSchedule.length) * 100).toFixed(1) : '0';
      document.getElementById('paymentProgress').textContent = `${progress}%`;
      
      // è®¡ç®—æ€»èŠ‚çœåˆ©æ¯
      const totalSaved = schedule.reduce((sum, s) => {
        if (s.note && s.note.includes('èŠ‚çœåˆ©æ¯')) {
          const match = s.note.match(/èŠ‚çœåˆ©æ¯â‰ˆ([\d.]+)/);
          return sum + (match ? parseFloat(match[1]) : 0);
        }
        return sum;
      }, 0);
      document.getElementById('savedInterest').textContent = `Â¥${totalSaved.toLocaleString()}`;
      
      // ä¼˜åŒ–å»ºè®®
      updateOptimizationTips(schedule, summary, remainingBalance, remainingInterest);
    }

    // æ›´æ–°ä¼˜åŒ–å»ºè®®
    function updateOptimizationTips(schedule, summary, remainingBalance, remainingInterest) {
      const tips = [];
      
      // åˆ†æå½“å‰åˆ©ç‡
      const currentRate = schedule[schedule.length - 1]?.rate || summary.annualRate;
      if (currentRate > 4.0) {
        tips.push('å½“å‰åˆ©ç‡è¾ƒé«˜ï¼Œå»ºè®®å…³æ³¨åˆ©ç‡è°ƒæ•´æ”¿ç­–');
      } else if (currentRate < 3.5) {
        tips.push('å½“å‰åˆ©ç‡è¾ƒä½ï¼Œæ˜¯è¿˜æ¬¾çš„å¥½æ—¶æœº');
      }
      
      // åˆ†ææå‰è¿˜æ¬¾æ•ˆæœ
      const prepayCount = schedule.filter(s => typeof s.period === 'string').length;
      if (prepayCount === 0) {
        tips.push('è€ƒè™‘é€‚å½“æå‰è¿˜æ¬¾ä»¥å‡å°‘åˆ©æ¯æ”¯å‡º');
      } else {
        tips.push('æå‰è¿˜æ¬¾ç­–ç•¥æ‰§è¡Œè‰¯å¥½ï¼Œç»§ç»­ä¿æŒ');
      }
      
      // åˆ†æè¿˜æ¬¾è¿›åº¦
      const normalSchedule = schedule.filter(s => typeof s.period === 'number');
      const totalInterest = normalSchedule.reduce((sum, s) => sum + s.interest, 0);
      const interestRatio = (totalInterest / summary.totalPayment) * 100;
      
      if (interestRatio > 30) {
        tips.push('åˆ©æ¯å æ¯”è¾ƒé«˜ï¼Œå»ºè®®å¢åŠ æå‰è¿˜æ¬¾é¢‘ç‡');
      } else if (interestRatio < 20) {
        tips.push('åˆ©æ¯æ§åˆ¶è‰¯å¥½ï¼Œå¯è€ƒè™‘å…¶ä»–æŠ•èµ„æœºä¼š');
      }
      
      // æ›´æ–°UI
      document.getElementById('tip1').textContent = tips[0] || 'æš‚æ— å»ºè®®';
      document.getElementById('tip2').textContent = tips[1] || '';
      document.getElementById('tip3').textContent = tips[2] || '';
    }

    window.addEventListener('DOMContentLoaded', () => {
      bindAutoSave();
      loadState();
    });
  </script>
</body>

</html>